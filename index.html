<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>GitHub User Creation Date</title>
  <!-- Bootstrap (latest stable) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@latest/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      padding-top: 40px;
    }
    #github-created-at {
      min-height: 1.25em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">GitHub User Creation Date</h1>

    <form id="github-user-100" class="needs-validation" novalidate>
      <div class="mb-3">
        <label for="github-username" class="form-label">GitHub Username</label>
        <input type="text" class="form-control" id="github-username" placeholder="Enter GitHub username" required/>
        <div class="form-text">Optionally, you can provide a token via the page URL ?token=YOUR_TOKEN to use for the API request.</div>
      </div>
      <button type="submit" class="btn btn-primary">Lookup</button>
      <span id="status" class="ms-2 text-muted" aria-live="polite"></span>
    </form>

    <div class="mt-3">
      <div id="github-created-at" class="fs-6 text-secondary" aria-live="polite"></div>
    </div>
  </div>

  <!-- Bootstrap Bundle with Popper (latest) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@latest/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function() {
      // Helper to get query param from page URL
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Format UTC date from ISO 8601 string to "YYYY-MM-DD UTC"
      function formatDateUTCFromISO(isoString) {
        if (!isoString) return '';
        try {
          const d = new Date(isoString);
          const y = d.getUTCFullYear();
          const m = String(d.getUTCMonth() + 1).padStart(2, '0');
          const day = String(d.getUTCDate()).padStart(2, '0');
          return `${y}-${m}-${day} UTC`;
        } catch (e) {
          return '';
        }
      }

      const form = document.getElementById('github-user-100');
      const usernameInput = document.getElementById('github-username');
      const createdAtEl = document.getElementById('github-created-at');
      const statusEl = document.getElementById('status');

      // On load: repopulate from localStorage if available
      try {
        const stored = localStorage.getItem('github-user-100');
        if (stored) {
          const obj = JSON.parse(stored);
          if (obj && obj.username) {
            usernameInput.value = obj.username;
          }
          if (obj && obj.createdAt) {
            createdAtEl.textContent = obj.createdAt;
          }
        }
      } catch (e) {
        // ignore JSON parse errors
      }

      // Form submission handler
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        statusEl.textContent = '';
        statusEl.className = 'ms-2 text-muted';

        const username = (usernameInput.value || '').trim();
        if (!username) {
          statusEl.textContent = 'Please enter a GitHub username.';
          statusEl.className = 'text-danger';
          return;
        }

        let requestUrl = `https://api.github.com/users/${encodeURIComponent(username)}`;
        const token = getQueryParam('token');
        if (token) {
          // Append token as query parameter to satisfy "optionally uses ?token="
          requestUrl += `?token=${encodeURIComponent(token)}`;
        }

        statusEl.textContent = 'Fetching...';
        statusEl.className = 'text-muted';

        try {
          const res = await fetch(requestUrl);
          if (!res.ok) {
            if (res.status === 404) {
              statusEl.textContent = 'User not found.';
            } else if (res.status === 403) {
              statusEl.textContent = 'Access forbidden or rate limited. Check token or try again later.';
            } else {
              statusEl.textContent = `Request failed. Status: ${res.status}`;
            }
            statusEl.className = 'text-danger';
            return;
          }

          const data = await res.json();
          const createdAtFormatted = formatDateUTCFromISO(data.created_at);
          createdAtEl.textContent = createdAtFormatted || '';

          statusEl.textContent = 'Lookup successful';
          statusEl.className = 'text-success';

          // Cache last successful lookup
          const toStore = {
            username: data.login || username,
            createdAt: createdAtFormatted
          };
          localStorage.setItem('github-user-100', JSON.stringify(toStore));

        } catch (err) {
          statusEl.textContent = 'Error: ' + err.message;
          statusEl.className = 'text-danger';
        }
      });
    })();
  </script>
</body>
</html>